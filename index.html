<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="color-scheme" content="light">
    <meta name="supported-color-schemes" content="light">
    <title>로컬링크 파트너 - 데이터 보상 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;900&display=swap');
        :root { color-scheme: light !important; }
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: #f8fafc !important; 
            color: #1e293b !important;
            margin: 0; 
            -webkit-font-smoothing: antialiased;
        }
        @media (prefers-color-scheme: dark) {
            body { background-color: #f8fafc !important; color: #1e293b !important; }
            .bg-white { background-color: #ffffff !important; color: #1e293b !important; }
            .bg-slate-50 { background-color: #f8fafc !important; }
            .bg-slate-900 { background-color: #0f172a !important; color: #ffffff !important; }
            .text-slate-900 { color: #0f172a !important; }
            .text-slate-500 { color: #64748b !important; }
            input, textarea, select { background-color: #ffffff !important; color: #000000 !important; border: 1px solid #e2e8f0 !important; }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .break-keep { word-break: keep-all; }
        
        .admin-table-container { overflow-x: auto; max-width: 100%; }
        table { min-width: 1100px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc, getDoc, setDoc, updateDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FirebaseSDK = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc, getDoc, setDoc, updateDoc, query, getDocs
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                "loader": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="spinner"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>,
                "database": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>,
                "target": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
                "gem": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 3h12l4 6-10 12L2 9Z"/><path d="M11 3 8 9l4 12 4-12-3-6"/><path d="M2 9h20"/></svg>,
                "chevron-right": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
                "arrow-left": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
                "check": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>,
                "send": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
                "shield": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>,
                "user": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
                "lock": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
                "alert-circle": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
                "share": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>,
                "clipboard-check": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg>,
                "save": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
                "edit": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.121a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
                "calendar": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
                "hand-tap": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-bounce"><path d="M10 11V6a1 1 0 0 1 2 0v5m0 0V4a1 1 0 0 1 2 0v7m0 0V6a1 1 0 0 1 2 0v5m0 0a1 1 0 0 1 2 0v7a8 8 0 0 1-8 8h-2a8 8 0 0 1-8-8V7a1 1 0 0 1 2 0v4" /></svg>,
                "refresh": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>,
                "settings": <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            };
            return <span className={`inline-block ${className}`} style={{ width: size, height: size }}>{icons[name] || null}</span>;
        };

        const THEMES = {
            general: { primary: "indigo", bg: "bg-indigo-600", text: "text-indigo-600", border: "border-indigo-600", light: "bg-indigo-50", isMedical: false },
            medical: { primary: "emerald", bg: "bg-emerald-600", text: "text-emerald-600", border: "border-emerald-600", light: "bg-emerald-50", isMedical: true }
        };

        const defaultFirebaseConfig = {
  apiKey: "AIzaSyBAngyJvkAQ5lbRNH3I5PI4TtPH1CFY7fA",
  authDomain: "link-final-a7d96.firebaseapp.com",
  projectId: "link-final-a7d96",
  storageBucket: "link-final-a7d96.firebasestorage.app",
  messagingSenderId: "764608459792",
  appId: "1:764608459792:web:2bf90ae95419c5d32c4695",
  measurementId: "G-TDS9MCRX70"
};;

        function App() {
            const [view, setView] = useState('survey'); 
            const [step, setStep] = useState(0);
            const [tier, setTier] = useState(null);
            const [user, setUser] = useState(null);
            const [adminType, setAdminType] = useState(null); 
            const [loginId, setLoginId] = useState("");
            const [pw, setPw] = useState("");
            const [isLoading, setIsLoading] = useState(true);
            const [leads, setLeads] = useState([]);
            const [allMerchants, setAllMerchants] = useState([]); 
            const [activeTab, setActiveTab] = useState("list");
            
            const [isMarketerLocked, setIsMarketerLocked] = useState(false);

            const [filters, setFilters] = useState({
                merchantId: "", tier: "", isConsulted: "all", isFake: "all", isRewardPaid: "all", marketerName: "", yearMonth: ""
            });

            const [config, setConfig] = useState({
                merchantId: "default", merchantName: "로컬링크 파트너", themeType: "general", marketerName: "",
                marketerRecipient: "", password: "1234",
                deliveryType: "owner",
                stdPrice: 120000, prePrice: 200000, stdReward: 25000, preReward: 50000,
                stdOptions: "사회 초년생, 신혼부부, 자녀양육, 은퇴준비",
                preOptions: "법인 대표, 개인사업자, 전문직, 자산가",
                stdQuestions: "월 고정 금융 비용 최적화 지표평가|생애 주기별 유동성 확보 데이터 평가|리스크 비용 & 비상 상황 대비 자산 완충 지수 평가|세무 비용 및 건강보험료 가계 부담 최적화 지표 데이터 평가",
                preQuestions: "사업 구조 전환에 따른 자산 가치 데이터 평가|미정산 재무 계정의 리스크 인덱스 및 정산 효율성 평가|사내 유보 자본의 유동화 및 자본 구조 최적화 지표 평가|기업 승계 데이터 유효성 검증 및 세대 간 자산 이동 효율성 평가",
                heroTitle: "우리 사장님이 직접 드리는 데이터 보상",
                heroSubText: "내방 고객을 위한 데이터 보상 혜택 시스템! 고객님의 라이프 지표를 데이터로 공급하고 리워드 포인트를 받으세요.",
                heroTitleMedical: "우리 원장님이 준비한 데이터 보상 시스템",
                heroSubTextMedical: "로컬링크 파트너 내방 고객을 위해 기다리시는 동안 데이터 보상 혜택 시스템! 고객님의 라이프 지표를 데이터로 공급하고 최대 5만 포인트 리워드로 받으세요.",
                medicalThanks: "고객님의 소중한 데이터도 정당한 자산이 되어야 합니다. “원장님인” 제가 보증하는 로컬링크의 투명한 분석을 통해 본인 데이터 자산의 가치를 발견하시길 바랍니다. 지역 사회의 데이터 주권 보호를 위해 함께해주셔서 감사합니다.",
                generalThanks: "고객님의 소중한 데이터도 정당한 자산이 되어야 합니다. 사장인 제가 보증하는 로컬링크의 투명한 분석을 통해서 전문가를 통한 본인데이터 자산의 가치를 발견하고, 새로운 자산의 가치를 창출하시길 바랍니다.",
                thirdPartyRecipient: "로컬링크 제휴 분석 전문가(보험설계사, 재무설계사, 경영지도사, 세무전문가, 법률전문가 등)",
                thirdPartyPurpose: "데이터 유효성 검증 실사 및 개인별 최적화 경영/가계 솔루션 제안",
                thirdPartyItems: "수집된 개인정보 및 설문 응답 데이터 일체",
                contractIntro: "•고객님이 보유하신 경제 지표의 소중한 가치를 인정해 드리는 데이터 리워드 프로그램입니다.",
            });

            const [formData, setFormData] = useState({ name: "", birth: "", phone: "", region: "", category: "", interest: "" });
            const [agreed, setAgreed] = useState({ collect: false, contract: false });

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'locallink-final-v2';
            const theme = THEMES[config.themeType] || THEMES.general;

            const getCalculatedReward = (lead) => {
                if (lead.isFake) return { owner: 0, platform: 0, marketer: 0 };
                const base = (Number(lead.sellingPrice) || 0) - (Number(lead.customerReward) || 0);
                return { 
                    owner: Math.floor(base * 0.35), 
                    platform: Math.floor(base * 0.50), 
                    marketer: Math.floor(base * 0.15) 
                };
            };

            useEffect(() => {
                const init = async () => {
                    if (!window.FirebaseSDK) return setTimeout(init, 100);
                    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, getDoc, signInWithCustomToken } = window.FirebaseSDK;
                    
                    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : defaultFirebaseConfig;
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    window.db = db;
                    
                    const initAuth = async () => {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    };
                    await initAuth();

                    const params = new URLSearchParams(window.location.search);
                    const mid = params.get('id');
                    if (mid) {
                        const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'merchants', mid));
                        if (snap.exists()) {
                            const data = snap.data();
                            setConfig(prev => ({ ...prev, ...data }));
                            if (data.marketerName && data.marketerName.trim() !== "") {
                                setIsMarketerLocked(true);
                            }
                        } else {
                            setConfig(prev => ({ ...prev, merchantId: mid }));
                        }
                    }
                    setIsLoading(false);
                    onAuthStateChanged(auth, setUser);
                };
                init();
            }, []);

            useEffect(() => {
                if (view === 'admin' && adminType && user) {
                    const { collection, onSnapshot } = window.FirebaseSDK;
                    const qLeads = collection(window.db, 'artifacts', appId, 'public', 'data', 'leads');
                    const unsubLeads = onSnapshot(qLeads, (snapshot) => {
                        let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (adminType === 'merchant') data = data.filter(l => l.merchantId === config.merchantId);
                        setLeads(data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                    }, (err) => console.error(err));

                    if (adminType === 'master') {
                        const qMerchants = collection(window.db, 'artifacts', appId, 'public', 'data', 'merchants');
                        const unsubMerchants = onSnapshot(qMerchants, (snapshot) => {
                            const data = snapshot.docs
                                .map(doc => ({ id: doc.id, ...doc.data() }))
                                .filter(m => m.id !== 'master_admin');
                            setAllMerchants(data);
                        }, (err) => console.error(err));
                        return () => { unsubLeads(); unsubMerchants(); };
                    }
                    return () => unsubLeads();
                }
            }, [view, adminType, user, config.merchantId]);

            const filteredLeads = useMemo(() => {
                return leads.filter(l => {
                    const midMatch = (l.merchantId || "").toLowerCase().includes(filters.merchantId.toLowerCase());
                    const tierMatch = filters.tier === "" || l.tier === filters.tier;
                    const consultedMatch = filters.isConsulted === "all" || String(l.isConsulted) === filters.isConsulted;
                    const fakeMatch = filters.isFake === "all" || String(l.isFake) === filters.isFake;
                    const paidMatch = filters.isRewardPaid === "all" || String(l.isRewardPaid) === filters.isRewardPaid;
                    const marketerMatch = (l.marketerName || "").toLowerCase().includes(filters.marketerName.toLowerCase());
                    
                    let ymMatch = true;
                    if (filters.yearMonth && l.createdAt?.toDate) {
                        const date = l.createdAt.toDate();
                        const y = date.getFullYear();
                        const m = String(date.getMonth() + 1).padStart(2, '0');
                        ymMatch = `${y}-${m}` === filters.yearMonth;
                    }
                    return midMatch && tierMatch && consultedMatch && fakeMatch && paidMatch && marketerMatch && ymMatch;
                });
            }, [leads, filters]);

            const totals = useMemo(() => {
                return filteredLeads.reduce((acc, l) => {
                    const rewards = getCalculatedReward(l);
                    acc.owner += rewards.owner; 
                    acc.platform += rewards.platform; 
                    acc.marketer += rewards.marketer;
                    acc.customerReward += (Number(l.customerReward) || 0);
                    acc.totalSales += (Number(l.sellingPrice) || 0);
                    return acc;
                }, { owner: 0, platform: 0, marketer: 0, customerReward: 0, totalSales: 0 });
            }, [filteredLeads]);

            const handleLogin = async () => {
                const { doc, getDoc } = window.FirebaseSDK;
                if (loginId === 'locallink') {
                    const masterSnap = await getDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'merchants', 'master_admin'));
                    const masterPass = masterSnap.exists() ? masterSnap.data().password : "1234";
                    if (pw === masterPass) setAdminType('master');
                    else alert("비밀번호가 틀렸습니다.");
                    return;
                }
                if (loginId === config.merchantId) {
                    const snap = await getDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'merchants', loginId));
                    const storedPass = snap.exists() ? snap.data().password : "1234";
                    if (pw === storedPass) setAdminType('merchant');
                    else alert("비밀번호가 틀렸습니다.");
                } else alert("ID가 일치하지 않습니다.");
            };

            const handleUpdatePassword = async (newPw) => {
                const { doc, updateDoc, setDoc, getDoc } = window.FirebaseSDK;
                if (!newPw) return alert("비밀번호를 입력하세요.");
                try {
                    const targetId = adminType === 'master' ? 'master_admin' : config.merchantId;
                    const docRef = doc(window.db, 'artifacts', appId, 'public', 'data', 'merchants', targetId);
                    const snap = await getDoc(docRef);
                    if (snap.exists()) await updateDoc(docRef, { password: newPw });
                    else await setDoc(docRef, { ...config, password: newPw });
                    alert("비밀번호가 변경되었습니다.");
                } catch (e) { alert("변경 실패"); }
            };

            const handleStatusUpdate = async (leadId, field, value) => {
                const { doc, updateDoc } = window.FirebaseSDK;
                await updateDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'leads', leadId), { [field]: value });
            };

            const handleSaveConfig = async () => {
                const { doc, setDoc } = window.FirebaseSDK;
                try {
                    await setDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'merchants', config.merchantId), config);
                    if (config.marketerName && config.marketerName.trim() !== "") {
                        setIsMarketerLocked(true);
                    }
                    alert("설정이 저장되었습니다.");
                } catch (e) { alert("저장 실패"); }
            };

            const handleMasterPricingUpdate = async (mId, pricingData) => {
                const { doc, updateDoc } = window.FirebaseSDK;
                try {
                    await updateDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'merchants', mId), pricingData);
                    alert(`${mId} 매장의 요금 정책이 업데이트되었습니다.`);
                } catch (e) {
                    alert("업데이트 실패");
                }
            };

            const handleMasterPasswordReset = async (mId) => {
                const { doc, updateDoc } = window.FirebaseSDK;
                if (!confirm(`${mId} 매장의 비밀번호를 '1234'로 초기화하시겠습니까?`)) return;
                try {
                    await updateDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'merchants', mId), { password: "1234" });
                    alert(`${mId} 매장의 비밀번호가 초기화되었습니다.`);
                } catch (e) {
                    alert("비밀번호 초기화 실패");
                }
            };

            const handleExportExcel = () => {
                if (filteredLeads.length === 0) return alert("내보낼 데이터가 없습니다.");
                const headers = ["No.", "접수일", "고객명", "생년월일", "연락처", "지역", "등급", "카테고리", "설문내용(평가대상)", "매장명", "영업자", "판매가", "고객리워드", "매장주수익(35%)", "플랫폼수익(50%)", "영업자수익(15%)", "상담완료", "허위여부", "지급상태"];
                const rows = filteredLeads.map((l, i) => {
                    const date = l.createdAt?.toDate() ? l.createdAt.toDate().toISOString().split('T')[0] : "-";
                    const rewards = getCalculatedReward(l);
                    return [
                        filteredLeads.length - i, date, l.name, l.birth, l.phone, l.region, l.tier, l.category, l.interest,
                        l.merchantName, l.marketerName, l.sellingPrice, l.customerReward, rewards.owner, rewards.platform, rewards.marketer, l.isConsulted ? "완료" : "대기", l.isFake ? "허위" : "정상", l.isRewardPaid ? "지급완료" : "지급대기"
                    ].map(val => `"${val}"`).join(",");
                });
                const summaryRow = ["", "합계", "", "", "", "", "", "", "", "", "", "", "", totals.owner, totals.platform, totals.marketer, "", "", ""].map(val => `"${val}"`).join(",");
                const csvContent = "\uFEFF" + [headers.join(","), ...rows, summaryRow].join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `로컬링크_정산데이터_${filters.yearMonth || new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleSubmit = async () => {
                if (!agreed.collect || !agreed.contract) return alert("필수 동의 항목에 체크해주세요.");
                if (!formData.name || !formData.phone) return alert("성함과 연락처를 입력해 주세요.");
                setIsLoading(true);
                const { collection, addDoc, serverTimestamp, getDocs } = window.FirebaseSDK;
                try {
                    const leadsSnap = await getDocs(collection(window.db, 'artifacts', appId, 'public', 'data', 'leads'));
                    const userLeads = leadsSnap.docs.map(d => d.data()).filter(l => l.name === formData.name && l.phone === formData.phone);
                    if (userLeads.length >= 2) { setIsLoading(false); return alert("해당 정보로 이미 2회 신청이 완료되었습니다."); }
                    if (userLeads.some(l => l.interest === formData.interest)) { setIsLoading(false); return alert("동일한 평가 항목으로 신청하신 내역이 있습니다."); }
                    const sellingPrice = tier === 'premium' ? config.prePrice : config.stdPrice;
                    const customerReward = tier === 'premium' ? config.preReward : config.stdReward;
                    await addDoc(collection(window.db, 'artifacts', appId, 'public', 'data', 'leads'), {
                        ...formData, merchantId: config.merchantId, merchantName: config.merchantName,
                        marketerName: config.marketerName, marketerRecipient: config.marketerRecipient || "정보 없음",
                        tier, sellingPrice, customerReward, isConsulted: false, isFake: false, isRewardPaid: false, createdAt: serverTimestamp()
                    });
                    setStep(3);
                } catch (e) { alert("저장 중 오류가 발생했습니다."); }
                setIsLoading(false);
            };

            const displayTitle = config.themeType === 'medical' ? (config.heroTitleMedical || "우리 원장님이 준비한 데이터 보상 시스템") : (config.heroTitle || "우리 사장님이 직접 드리는 데이터 보상");
            const displaySubText = config.themeType === 'medical' ? (config.heroSubTextMedical || "로컬링크 파트너 내방 고객을 위해 기다리시는 동안 데이터 보상 혜택 시스템! 고객님의 라이프 지표를 데이터로 공급하고 최대 5만 포인트 리워드로 받으세요.") : config.heroSubText;

            if (isLoading) return <div className="min-h-screen flex items-center justify-center bg-white"><Icon name="loader" size={48} className="text-indigo-600" /></div>;

            return (
                <div className="min-h-screen flex flex-col items-center overflow-x-hidden relative">
                    {view === 'survey' ? (
                        <div className="w-full max-w-md bg-white min-h-screen flex flex-col relative shadow-2xl">
                            <div className="flex-1 pb-10">
                                {step === 0 && (
                                    <div className="animate-fade-in">
                                        <div className="p-8 pt-12 bg-slate-50 border-b border-slate-100 rounded-b-[2.5rem]">
                                            <div className={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full ${theme.light} ${theme.text} text-[10px] font-black uppercase tracking-widest mb-4`}>
                                                <Icon name="database" size={12} /> Data Reward System
                                            </div>
                                            <h1 className="text-[1.7rem] font-black leading-[1.3] mb-4 break-keep">{displayTitle}</h1>
                                            <p className="text-slate-500 text-[14px] font-medium leading-relaxed break-keep opacity-90 mb-4">{displaySubText}</p>
                                            {config.themeType === 'medical' && (
                                                <div className="flex gap-2 p-3.5 bg-emerald-50 border border-emerald-100 rounded-2xl animate-fade-in">
                                                    <div className="mt-0.5"><Icon name="alert-circle" size={14} className="text-emerald-600"/></div>
                                                    <p className="text-[10px] text-emerald-800 font-bold leading-relaxed break-keep">
                                                        본 프로그램은 의료법 및 금융소비자보호법을 준수합니다. 제공되는 보상은 진료나 조제, 금융상품 가입의 대가가 아닌 데이터 가치 분석에 따른 정당한 정보 이용료입니다.
                                                    </p>
                                                </div>
                                            )}
                                            <div className="grid grid-cols-2 gap-3 mt-6">
                                                <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-center">
                                                    <p className="text-[9px] font-black text-slate-400 uppercase mb-1">참여율</p>
                                                    <p className="text-xl font-black">96.8%</p>
                                                </div>
                                                <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-center">
                                                    <p className="text-[9px] font-black text-slate-400 uppercase mb-1">최대 보상</p>
                                                    <p className={`text-xl font-black ${theme.text}`}>5만 포인트</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="p-6 space-y-4">
                                            <button onClick={() => { setTier('standard'); setStep(1); }} className="w-full p-6 bg-white border-2 border-slate-100 rounded-3xl text-left transition-all active:scale-95 shadow-sm hover:border-indigo-500 relative overflow-hidden group">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div className="p-3 bg-indigo-50 text-indigo-600 rounded-xl"><Icon name="target" size={24}/></div>
                                                    <span className="text-[10px] font-black text-slate-300 uppercase tracking-tighter italic">Lifestyle Index</span>
                                                </div>
                                                <h3 className="text-lg font-black mb-1 text-slate-900 italic">가계 경제 지표 가치회복</h3>
                                                <div className="flex justify-between items-end">
                                                    <div><span className="text-xl font-black text-indigo-600">2.5만 포인트</span><p className="text-[9px] font-bold text-rose-500 mt-1">※ 대면 실검증 시 제공</p></div>
                                                    <div className="flex flex-col items-center">
                                                        <Icon name="hand-tap" size={24} className="text-indigo-400 mb-1" />
                                                        <Icon name="chevron-right" className="text-slate-200" />
                                                    </div>
                                                </div>
                                            </button>
                                            <button onClick={() => { setTier('premium'); setStep(1); }} className="w-full p-6 bg-slate-900 text-white rounded-3xl text-left transition-all active:scale-95 shadow-xl relative overflow-hidden group">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div className={`p-3 ${theme.bg} text-white rounded-xl shadow-lg`}><Icon name="gem" size={24}/></div>
                                                    <span className="text-[10px] font-black text-white/30 uppercase italic tracking-tighter">Premium Strategy</span>
                                                </div>
                                                <h3 className="text-lg font-black mb-1 text-white italic">기업경영 전략 인덱스 보상</h3>
                                                <div className="flex justify-between items-end">
                                                    <div><span className={`text-xl font-black text-teal-400`}>5만 포인트</span><p className="text-[9px] font-bold text-teal-400/60 mt-1">※ 대면 실검증 시 제공</p></div>
                                                    <div className="flex flex-col items-center">
                                                        <Icon name="hand-tap" size={24} className="text-teal-400 mb-1" />
                                                        <Icon name="chevron-right" className="text-white/20" />
                                                    </div>
                                                </div>
                                            </button>
                                            <div className={`mt-8 p-6 ${theme.light} border-2 ${theme.border} border-dashed rounded-[2rem] relative`}>
                                                <div className={`absolute -top-3 left-6 px-3 py-1 bg-white border ${theme.border} rounded-full flex items-center gap-1.5`}>
                                                    <Icon name="send" size={10} className={theme.text} />
                                                    <span className={`text-[10px] font-black ${theme.text} uppercase tracking-widest`}>{config.themeType === 'medical' ? '원장님' : '사장님'}의 편지</span>
                                                </div>
                                                <p className="text-[13px] font-bold leading-relaxed text-slate-700 break-keep italic text-center">"{config.themeType === 'medical' ? config.medicalThanks : config.generalThanks}"</p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {step === 1 && (
                                    <div className="p-8 animate-fade-in">
                                        <button onClick={() => setStep(0)} className="mb-6 text-slate-400 flex items-center gap-1 font-bold text-xs hover:text-slate-600 transition-colors"><Icon name="arrow-left" size={14}/> 이전으로</button>
                                        <h2 className="text-2xl font-black text-slate-900 mb-8 italic uppercase tracking-tighter underline decoration-indigo-500 decoration-4">Data Indexing</h2>
                                        <p className="text-[13px] font-bold text-slate-500 mb-8 ml-0.5">본인의 데이터 그룹을 선택해 주세요.</p>
                                        <div className="grid grid-cols-2 gap-3 mb-10">
                                            {(tier === 'standard' ? config.stdOptions.split(',') : config.preOptions.split(',')).map(c => (
                                                <button key={c} onClick={() => setFormData({...formData, category: c.trim()})} className={`py-4 rounded-xl border-2 text-[12px] font-black transition-all ${formData.category === c.trim() ? `${theme.border} ${theme.light} ${theme.text}` : 'bg-slate-50 text-slate-400 border-transparent active:bg-slate-100'}`}>{c.trim()}</button>
                                            ))}
                                        </div>
                                        <div className="space-y-4"><div className="ml-1 mb-2"><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest italic mb-1">EVALUATION TARGET</p><p className="text-[13px] font-bold text-slate-500">데이터 평가 항목을 선택해주세요</p></div>
                                            {(tier === 'standard' ? config.stdQuestions.split('|') : config.preQuestions.split('|')).map(q => (
                                                <button key={q} onClick={() => setFormData({...formData, interest: q.trim()})} className={`w-full p-5 rounded-xl border-2 text-left text-[12px] font-bold transition-all break-keep ${formData.interest === q.trim() ? `${theme.border} ${theme.light} ${theme.text}` : 'bg-slate-50 text-slate-400 border-transparent active:bg-slate-100'}`}>{q.trim()}</button>
                                            ))}
                                        </div>
                                        <button disabled={!formData.category || !formData.interest} onClick={() => setStep(2)} className={`mt-12 w-full ${theme.bg} text-white py-5 rounded-2xl font-black shadow-xl disabled:opacity-30 uppercase tracking-widest`}>다음 단계로</button>
                                    </div>
                                )}
                                {step === 2 && (
                                    <div className="p-8 animate-fade-in overflow-y-auto pb-20">
                                        <button onClick={() => setStep(1)} className="mb-6 text-slate-400 flex items-center gap-1 font-bold text-xs"><Icon name="arrow-left" size={14}/> 이전으로</button>
                                        <h2 className="text-2xl font-black text-slate-900 mb-8 italic uppercase tracking-tighter underline decoration-emerald-500 decoration-4">Contract</h2>
                                        <p className="text-slate-500 text-[13px] font-bold mb-8 ml-0.5">정확한 데이터 가치 산정을 위해 정보를 입력해 주세요.</p>
                                        <div className="space-y-4 mb-8">
                                            <input type="text" placeholder="성함" className="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none border-2 border-transparent focus:border-indigo-500" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                            <div className="grid grid-cols-2 gap-3"><input type="text" placeholder="생년월일 (6자리)" className="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none border-2 border-transparent focus:border-indigo-500" value={formData.birth} onChange={e => setFormData({...formData, birth: e.target.value})} /><input type="tel" placeholder="연락처 (-제외)" className="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none border-2 border-transparent focus:border-indigo-500" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} /></div>
                                            <input type="text" placeholder="거주 지역 (시/군/구)" className="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none border-2 border-transparent focus:border-indigo-500" value={formData.region} onChange={e => setFormData({...formData, region: e.target.value})} />
                                        </div>
                                        <div className="space-y-4 mb-10">
                                            <div className="bg-slate-50 p-5 rounded-2xl border border-slate-100"><div className="flex items-center gap-3 mb-4 cursor-pointer" onClick={() => setAgreed({...agreed, collect: !agreed.collect})}><div className={`w-5 h-5 rounded flex items-center justify-center border-2 transition-all ${agreed.collect ? 'bg-indigo-600 border-indigo-600 shadow-md shadow-indigo-200' : 'bg-white border-slate-200'}`}>{agreed.collect && <Icon name="check" size={14} className="text-white"/>}</div><span className="text-[11px] font-black text-slate-700 uppercase italic">[필수] 개인정보 수집 및 제3자 제공 동의</span></div>
                                                <div className="space-y-4 text-[9px] text-slate-500 font-bold leading-relaxed"><div className="bg-white p-3 rounded-xl border border-slate-100"><p className="text-[10px] text-indigo-600 mb-1 font-black">1. 개인정보 수집 및 이용</p><p>• 수집 항목: 성명, 생년월일, 연락처, 주소, 설문 데이터</p><p>• 수집 목적: 데이터 가치 산정 및 보상 지급 자격 확인, 전문가 매칭 안내</p><p>• 보유 기간: 보상 지급 완료 후 1년 또는 정보 주체의 파기 요청 시까지</p></div>
                                                    <div className="bg-white p-3 rounded-xl border border-slate-100"><p className="text-[10px] text-emerald-600 mb-1 font-black">2. 제공받는 자 및 제3자 동의</p><p>• 제공받는 자: {config.thirdPartyRecipient}</p><p>• 제공 목적: {config.thirdPartyPurpose}</p><p>• 제공 항목: {config.thirdPartyItems}</p></div>
                                                </div>
                                            </div>
                                            <div className="bg-slate-900 p-6 rounded-2xl shadow-lg cursor-pointer" onClick={() => setAgreed({...agreed, contract: !agreed.contract})}><div className="flex items-start gap-4 mb-4 text-white"><div className={`mt-0.5 w-5 h-5 rounded flex items-center justify-center border-2 transition-all ${agreed.contract ? 'bg-emerald-500 border-emerald-500 shadow-md shadow-emerald-900' : 'bg-white/10 border-white/20'}`}>{agreed.contract && <Icon name="check" size={14} className="text-white"/>}</div><span className="text-[11px] font-black uppercase italic">[필수] 데이터 커머스 참여 및 보상 지급 동의</span></div><div className="text-[10px] text-white/70 leading-relaxed font-medium italic space-y-2"><p>{config.contractIntro}</p><p>•보상 안내 : 배정된 담당 전문가와 가벼운 미팅을 통해 데이터의 가치를 확인해 주세요 . 확인절차가 완료되면 확정된 보상금이 바로 지급됩니다.</p></div></div>
                                            <div className="px-2 py-1 flex items-start gap-1.5"><div className="mt-0.5"><Icon name="alert-circle" size={12} className="text-slate-400"/></div><p className="text-[9px] font-bold text-slate-400 leading-normal break-keep">* 본 프로그램은 특정 금융상품 가입을 강제하지 않으며, 정당한 데이터 거래 계약을 기반으로 운영됩니다.</p></div>
                                        </div>
                                        <button onClick={handleSubmit} className={`w-full ${theme.bg} text-white py-5 rounded-2xl font-black text-lg shadow-xl uppercase active:scale-95 transition-all`}>신청 완료</button>
                                    </div>
                                )}
                                {step === 3 && (
                                    <div className="flex-1 flex flex-col items-center justify-center p-8 text-center animate-fade-in">
                                        <div className={`w-24 h-24 ${theme.light} ${theme.text} rounded-full flex items-center justify-center mb-10 shadow-inner`}><Icon name="clipboard-check" size={48} /></div>
                                        <h2 className="text-3xl font-black mb-6 italic uppercase tracking-tighter underline decoration-indigo-500 decoration-8 break-keep">데이터 매매 신청이 완료되었습니다.</h2>
                                        <p className="text-slate-600 font-bold mb-10 break-keep italic leading-relaxed">
                                            {config.deliveryType === 'direct' 
                                                ? "배정된 분석 전문가와의 대면 검증후 플랫폼에서 약속된 보상을 직접 전송해 드립니다."
                                                : "배정된 분석 전문가와의 대면 검증후 플랫폼에서 약속된 보상을 사장님을 통해서 전달해 드립니다.(상품권, 리워드 등)"
                                            }
                                        </p>
                                        <button onClick={() => window.location.reload()} className="w-full bg-slate-900 text-white p-5 rounded-2xl font-black uppercase shadow-xl">확인</button>
                                    </div>
                                )}
                            </div>

                            <div className="pb-8 mt-4 flex flex-col items-center opacity-70 space-y-2">
                                <p className="text-[12px] font-black text-slate-600 tracking-[0.12em] uppercase flex items-center gap-1.5">
                                    <span className="opacity-50">로컬링크-홍익인간BSR</span> 
                                    <span className="text-indigo-500 font-black">X</span> 
                                    <span className="text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded-md border border-indigo-100">{config.merchantId}</span>
                                </p>
                                <p className="text-[10px] font-black text-white tracking-wider bg-slate-900 border border-slate-800 px-3 py-1 rounded-full shadow-lg">
                                    특허출원 : 10-2025-0205952
                                </p>
                            </div>

                            <div className="p-4 bg-slate-50 border-t border-slate-100 flex justify-center">
                                <button onClick={() => setView('admin')} className="text-[10px] font-black text-slate-300 uppercase tracking-widest flex items-center gap-1.5 hover:text-indigo-400 transition-colors">
                                    <Icon name="lock" size={10} /> 관리자 모드 진입
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="w-full max-w-7xl bg-slate-50 min-h-screen p-6 flex flex-col items-center">
                            {adminType ? (
                                <div className="w-full animate-fade-in">
                                    <header className="flex justify-between items-center mb-6 w-full">
                                        <div className="flex flex-col">
                                            <h1 className="text-2xl font-black italic underline decoration-indigo-500 decoration-[6px]">Control Center</h1>
                                            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{adminType === 'master' ? 'Master Admin' : `Merchant: ${config.merchantId}`}</span>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setActiveTab("list")} className={`px-4 py-2 rounded-full text-[10px] font-black ${activeTab === 'list' ? 'bg-slate-900 text-white' : 'bg-white text-slate-400'}`}>Leads ({filteredLeads.length})</button>
                                            <button onClick={() => setActiveTab("settings")} className={`px-4 py-2 rounded-full text-[10px] font-black ${activeTab === 'settings' ? 'bg-slate-900 text-white' : 'bg-white text-slate-400'}`}>Settings</button>
                                            <button onClick={() => { setAdminType(null); setView('survey'); }} className="px-4 py-2 bg-rose-50 text-rose-500 rounded-full text-[10px] font-black uppercase">Logout</button>
                                        </div>
                                    </header>

                                    {activeTab === 'list' ? (
                                        <div className="space-y-4 animate-fade-in">
                                            <div className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 flex flex-wrap gap-6 items-end justify-between"><div className="flex flex-wrap gap-4 items-end">
                                                    {adminType === 'master' && (
                                                        <>
                                                            <div className="w-32">
                                                                <label className="text-[9px] font-black text-slate-400 block mb-1">매장 ID</label>
                                                                <input className="w-full p-2 bg-slate-50 rounded-lg text-[11px] font-bold border border-slate-100" value={filters.merchantId} onChange={e => setFilters({...filters, merchantId: e.target.value})} placeholder="ID 입력" />
                                                            </div>
                                                            <div className="w-32">
                                                                <label className="text-[9px] font-black text-emerald-600 block mb-1">영업자 필터</label>
                                                                <input className="w-full p-2 bg-emerald-50 rounded-lg text-[11px] font-bold border border-emerald-100" value={filters.marketerName} onChange={e => setFilters({...filters, marketerName: e.target.value})} placeholder="영업자명" />
                                                            </div>
                                                        </>
                                                    )}
                                                    <div className="w-40">
                                                        <label className="text-[9px] font-black text-indigo-600 block mb-1 uppercase flex items-center gap-1"><Icon name="calendar" size={10} /> 접수년월 필터</label>
                                                        <input type="month" className="w-full p-2 bg-indigo-50/50 rounded-lg text-[11px] font-black border border-indigo-100" value={filters.yearMonth} onChange={e => setFilters({...filters, yearMonth: e.target.value})} />
                                                    </div>
                                                    <div className="w-24"><label className="text-[9px] font-black text-slate-400 block mb-1">등급</label><select className="w-full p-2 bg-slate-50 rounded-lg text-[11px] font-bold border border-slate-100" value={filters.tier} onChange={e => setFilters({...filters, tier: e.target.value})}><option value="">전체</option><option value="standard">Standard</option><option value="premium">Premium</option></select></div>
                                                    <div className="w-24"><label className="text-[9px] font-black text-slate-400 block mb-1">상담여부</label><select className="w-full p-2 bg-slate-50 rounded-lg text-[11px] font-bold border border-slate-100" value={filters.isConsulted} onChange={e => setFilters({...filters, isConsulted: e.target.value})}><option value="all">전체</option><option value="true">완료</option><option value="false">대기</option></select></div>
                                                    <div className="w-24"><label className="text-[9px] font-black text-slate-400 block mb-1">허위여부</label><select className="w-full p-2 bg-slate-50 rounded-lg text-[11px] font-bold border border-slate-100" value={filters.isFake} onChange={e => setFilters({...filters, isFake: e.target.value})}><option value="all">전체</option><option value="true">허위</option><option value="false">정상</option></select></div>
                                                    <div className="w-24"><label className="text-[9px] font-black text-slate-400 block mb-1">지급상태</label><select className="w-full p-2 bg-slate-50 rounded-lg text-[11px] font-bold border border-slate-100" value={filters.isRewardPaid} onChange={e => setFilters({...filters, isRewardPaid: e.target.value})}><option value="all">전체</option><option value="true">지급완료</option><option value="false">지급대기</option></select></div>
                                                </div><button onClick={handleExportExcel} className="bg-slate-900 text-white px-6 py-2 rounded-xl text-[10px] font-black uppercase flex items-center gap-2 shadow-lg h-[35px] hover:bg-black transition-all"><Icon name="share" size={14}/> Excel Export</button></div>
                                            <div className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 w-full overflow-hidden">
                                                <div className="admin-table-container">
                                                    <table className="w-full text-left text-[11px] font-bold">
                                                        <thead className="bg-slate-900 text-white text-[9px] font-black uppercase italic">
                                                            <tr>
                                                                <th className="p-4 w-12">No.</th>
                                                                <th className="p-4">접수일</th>
                                                                <th className="p-4">고객/연락처</th>
                                                                <th className="p-4">등급/지역</th>
                                                                {adminType === 'master' && <th className="p-4">설문내용</th>}
                                                                <th className="p-4">매장 ID</th>
                                                                <th className="p-4">영업자</th>
                                                                <th className="p-4">상담/허위</th>
                                                                <th className="p-4">리워드 정산</th>
                                                                <th className="p-4">지급상태</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>{filteredLeads.map((l, i) => { const rewards = getCalculatedReward(l); const dateOnly = l.createdAt?.toDate() ? l.createdAt.toDate().toISOString().split('T')[0] : "-"; return (<tr key={l.id} className={`border-b border-slate-50 ${l.isFake ? 'bg-rose-50 opacity-60' : ''}`}><td className="p-4 text-slate-400 italic">{filteredLeads.length - i}</td><td className="p-4 text-slate-500 font-medium">{dateOnly}</td><td className="p-4">{l.name}<br/><span className="text-slate-400 font-medium">{l.phone}</span></td><td className="p-4 uppercase">{l.tier}<br/><span className="text-slate-400 font-medium">{l.region}</span></td>{adminType === 'master' && <td className="p-4 text-slate-500 font-medium break-keep">[{l.category}]<br/>{l.interest}</td>}<td className="p-4 font-black text-indigo-600 italic">{l.merchantId}</td><td className="p-4 text-emerald-600 font-black italic">{l.marketerName}</td><td className="p-4 space-y-1"><label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" checked={l.isConsulted} onChange={(e) => handleStatusUpdate(l.id, 'isConsulted', e.target.checked)} /> 상담완료</label><label className="flex items-center gap-1 cursor-pointer text-rose-500"><input type="checkbox" checked={l.isFake} onChange={(e) => handleStatusUpdate(l.id, 'isFake', e.target.checked)} /> 허위정보</label></td><td className="p-4"><div className="flex flex-col gap-0.5"><span className="text-indigo-600 font-black">매장: {rewards.owner.toLocaleString()}원</span><span className="text-slate-500 text-[10px]">플랫폼: {rewards.platform.toLocaleString()}원</span><span className="text-emerald-600 text-[10px]">영업: {rewards.marketer.toLocaleString()}원</span></div></td><td className="p-4"><button onClick={() => handleStatusUpdate(l.id, 'isRewardPaid', !l.isRewardPaid)} className={`px-3 py-1.5 rounded-lg text-[9px] font-black uppercase transition-colors ${l.isRewardPaid ? 'bg-emerald-500 text-white shadow-md' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>{l.isRewardPaid ? '지급완료' : '지급대기'} </button></td></tr>);})}</tbody>
                                                    </table>
                                                </div>
                                                <div className="mt-6 p-6 bg-slate-900 rounded-2xl flex flex-wrap justify-between items-center text-white gap-6">
                                                    <div className="flex flex-wrap gap-8">
                                                        <div><p className="text-[10px] font-black text-slate-400 uppercase mb-1">Total Count</p><p className="text-xl font-black italic">{filteredLeads.length} 건</p></div>
                                                        <div className="border-l border-white/10 pl-8"><p className="text-[10px] font-black text-rose-400 uppercase mb-1">Total Customer Reward</p><p className="text-xl font-black text-rose-400">{totals.customerReward.toLocaleString()} 원</p></div>
                                                        <div className="border-l border-white/10 pl-8"><p className="text-[10px] font-black text-indigo-400 uppercase mb-1">Total Merchant</p><p className="text-xl font-black text-indigo-400">{totals.owner.toLocaleString()} 원</p></div>
                                                        <div className="border-l border-white/10 pl-8"><p className="text-[10px] font-black text-slate-300 uppercase mb-1">Total Platform</p><p className="text-xl font-black text-white">{totals.platform.toLocaleString()} 원</p></div>
                                                        <div className="border-l border-white/10 pl-8"><p className="text-[10px] font-black text-emerald-400 uppercase mb-1">Total Marketer</p><p className="text-xl font-black text-emerald-400">{totals.marketer.toLocaleString()} 원</p></div>
                                                        <div className="border-l border-white/10 pl-8"><p className="text-[10px] font-black text-yellow-400 uppercase mb-1">Total Sales Revenue</p><p className="text-2xl font-black text-yellow-400">{totals.totalSales.toLocaleString()} 원</p></div>
                                                    </div>
                                                    <div className="text-right"><p className="text-[9px] text-white/30 italic font-medium">* {filters.yearMonth ? `${filters.yearMonth} 검색 결과` : '전체 기간'} 합계</p></div>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full animate-fade-in pb-20">
                                            <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 h-fit">
                                                <h3 className="font-black mb-6 italic text-indigo-600 uppercase tracking-tighter">Category & Theme Settings</h3>
                                                <div className="space-y-6">
                                                    <div className="p-5 bg-slate-900 rounded-3xl"><p className="text-[10px] font-black text-indigo-400 uppercase italic mb-3 flex items-center gap-1.5"><Icon name="settings" size={12}/> 매장 카테고리 선택</p><div className="flex gap-2"><button onClick={() => setConfig({...config, themeType: 'general'})} className={`flex-1 p-4 rounded-2xl font-black text-[10px] uppercase transition-all ${config.themeType === 'general' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white/5 text-white/30 border border-white/10'}`}>카테고리 1 (일반매장)</button><button onClick={() => setConfig({...config, themeType: 'medical'})} className={`flex-1 p-4 rounded-2xl font-black text-[10px] uppercase transition-all ${config.themeType === 'medical' ? 'bg-emerald-600 text-white shadow-lg' : 'bg-white/5 text-white/30 border border-white/10'}`}>카테고리 2 (병원/약국)</button></div></div>
                                                    <div className="space-y-4"><h4 className="text-[11px] font-black text-slate-800 uppercase flex items-center gap-1.5 border-b pb-2"><Icon name="edit" size={12}/> Content Customization</h4>
                                                        {config.themeType === 'general' ? (<><div><label className="text-[10px] font-black text-slate-400 ml-1 uppercase mb-1 block">Main Title (일반 매장)</label><input className="w-full p-4 bg-slate-50 border border-slate-100 rounded-xl font-bold text-xs" value={config.heroTitle} onChange={e => setConfig({...config, heroTitle: e.target.value})} /></div><div><label className="text-[10px] font-black text-slate-400 ml-1 uppercase mb-1 block">Sub Text (일반 매장)</label><textarea className="w-full p-4 bg-slate-50 border border-slate-100 rounded-xl font-bold text-xs h-20 resize-none" value={config.heroSubText} onChange={e => setConfig({...config, heroSubText: e.target.value})} /></div><div><label className="text-[10px] font-black text-indigo-600 ml-1 uppercase mb-1 block">사장님의 편지 (감사 멘트)</label><textarea className="w-full p-4 bg-indigo-50 border border-indigo-100 rounded-xl font-bold text-xs h-24 resize-none" value={config.generalThanks} onChange={e => setConfig({...config, generalThanks: e.target.value})} /></div></>) : (<><div><label className="text-[10px] font-black text-emerald-600 ml-1 uppercase mb-1 block">Main Title (병원/약국)</label><input className="w-full p-4 bg-emerald-50 border border-emerald-100 rounded-xl font-bold text-xs" value={config.heroTitleMedical} onChange={e => setConfig({...config, heroTitleMedical: e.target.value})} /></div><div><label className="text-[10px] font-black text-emerald-600 ml-1 uppercase mb-1 block">Sub Text (병원/약국)</label><textarea className="w-full p-4 bg-emerald-50 border border-emerald-100 rounded-xl font-bold text-xs h-24 resize-none" value={config.heroSubTextMedical} onChange={e => setConfig({...config, heroSubTextMedical: e.target.value})} /></div><div><label className="text-[10px] font-black text-emerald-700 ml-1 uppercase mb-1 block">원장님의 편지 (감사 멘트)</label><textarea className="w-full p-4 bg-emerald-100/50 border border-emerald-200 rounded-xl font-bold text-xs h-24 resize-none" value={config.medicalThanks} onChange={e => setConfig({...config, medicalThanks: e.target.value})} /></div></>)}
                                                    </div>
                                                    <div className="p-4 bg-indigo-50 rounded-2xl border border-indigo-100"><p className="text-[10px] font-black text-indigo-600 uppercase mb-3 flex items-center gap-1.5">보상 전달 방식</p><div className="flex gap-2"><button onClick={() => setConfig({...config, deliveryType: 'direct'})} className={`flex-1 p-3 rounded-xl font-black text-[10px] uppercase transition-all ${config.deliveryType === 'direct' ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-400'}`}>플랫폼 직접 전송</button><button onClick={() => setConfig({...config, deliveryType: 'owner'})} className={`flex-1 p-3 rounded-xl font-black text-[10px] uppercase transition-all ${config.deliveryType === 'owner' ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-400'}`}>사장님 통해 전달</button></div></div>
                                                    <div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] font-black text-slate-400 ml-1 uppercase mb-2 block">Merchant Name</label><input className="w-full p-4 bg-slate-50 border border-slate-100 rounded-xl font-bold text-xs" value={config.merchantName} onChange={e => setConfig({...config, merchantName: e.target.value})} /></div><div><label className="text-[10px] font-black text-slate-400 ml-1 uppercase mb-2 block">영업자명</label><input className={`w-full p-4 rounded-xl font-bold text-xs border ${isMarketerLocked ? 'bg-slate-100 text-slate-400 cursor-not-allowed border-slate-200' : 'bg-white border-slate-100'}`} value={config.marketerName} onChange={e => !isMarketerLocked && setConfig({...config, marketerName: e.target.value})} disabled={isMarketerLocked} placeholder="영업자 성함" /></div></div>
                                                    <button onClick={handleSaveConfig} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-xl flex items-center justify-center gap-2 hover:bg-black transition-all"><Icon name="save" size={16}/> Save All Category Settings</button>
                                                </div>
                                            </div>

                                            <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 h-fit space-y-8">
                                                <div className="h-fit">
                                                    <h3 className="font-black mb-6 italic text-rose-600 uppercase tracking-tighter">Pricing & Security</h3>
                                                    <div className="space-y-6">
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <div>
                                                                <label className="text-[10px] font-black text-indigo-600 ml-1 uppercase mb-2 block italic">Std Price (판매가)</label>
                                                                <input 
                                                                    type="number" 
                                                                    className={`w-full p-4 rounded-xl font-black text-xs border ${adminType === 'master' ? 'bg-indigo-50 border-indigo-100' : 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'}`} 
                                                                    value={config.stdPrice} 
                                                                    onChange={e => adminType === 'master' && setConfig({...config, stdPrice: Number(e.target.value)})} 
                                                                    disabled={adminType !== 'master'} 
                                                                />
                                                                <label className="text-[9px] text-slate-400 mt-2 block ml-1">Std Reward (고객 리워드)</label>
                                                                <input 
                                                                    type="number" 
                                                                    className={`w-full p-3 rounded-lg font-bold text-xs mt-1 border ${adminType === 'master' ? 'bg-slate-50 border-slate-100' : 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'}`} 
                                                                    value={config.stdReward} 
                                                                    onChange={e => adminType === 'master' && setConfig({...config, stdReward: Number(e.target.value)})} 
                                                                    disabled={adminType !== 'master'} 
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="text-[10px] font-black text-teal-600 ml-1 uppercase mb-2 block italic">Pre Price (판매가)</label>
                                                                <input 
                                                                    type="number" 
                                                                    className={`w-full p-4 rounded-xl font-black text-xs border ${adminType === 'master' ? 'bg-teal-50 border-teal-100' : 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'}`} 
                                                                    value={config.prePrice} 
                                                                    onChange={e => adminType === 'master' && setConfig({...config, prePrice: Number(e.target.value)})} 
                                                                    disabled={adminType !== 'master'} 
                                                                />
                                                                <label className="text-[9px] text-slate-400 mt-2 block ml-1">Pre Reward (고객 리워드)</label>
                                                                <input 
                                                                    type="number" 
                                                                    className={`w-full p-3 rounded-lg font-bold text-xs mt-1 border ${adminType === 'master' ? 'bg-slate-50 border-slate-100' : 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'}`} 
                                                                    value={config.preReward} 
                                                                    onChange={e => adminType === 'master' && setConfig({...config, preReward: Number(e.target.value)})} 
                                                                    disabled={adminType !== 'master'} 
                                                                />
                                                            </div>
                                                        </div>
                                                        {adminType !== 'master' && <p className="text-[9px] text-rose-500 font-bold ml-1">* 보상 및 판매가 정책은 마스터 관리자만 수정 가능합니다.</p>}

                                                        <div className="p-6 bg-rose-50 rounded-3xl border border-rose-100">
                                                            <label className="text-[10px] font-black text-rose-600 ml-1 uppercase mb-2 block italic tracking-widest">Change Account Password</label>
                                                            <input type="password" id="new_pw" placeholder="Enter New Password" onKeyDown={(e) => e.key === 'Enter' && handleUpdatePassword(e.target.value)} className="w-full p-4 bg-white border border-rose-100 rounded-xl font-bold text-xs mb-4 outline-none focus:ring-2 focus:ring-rose-500" />
                                                            <button onClick={() => handleUpdatePassword(document.getElementById('new_pw').value)} className="w-full bg-rose-500 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-lg hover:bg-rose-600 transition-all">Update Access Key</button>
                                                        </div>
                                                        <div className="p-6 bg-slate-900 rounded-3xl">
                                                            <p className="text-[10px] font-black text-indigo-400 uppercase italic mb-2 tracking-widest underline decoration-indigo-400">Account / QR ID</p>
                                                            <input className="w-full p-4 bg-white/5 border border-white/10 rounded-2xl font-bold text-white mb-4 outline-none" value={config.merchantId} disabled={adminType !== 'master'} onChange={e => setConfig({...config, merchantId: e.target.value})} /><button onClick={handleSaveConfig} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-xl flex items-center justify-center gap-2 hover:bg-indigo-500 transition-all"><Icon name="save" size={16}/> Sync ID</button></div>
                                                    </div>
                                                </div>

                                                {adminType === 'master' && (
                                                    <div className="pt-10 border-t border-slate-100 animate-fade-in">
                                                        <h3 className="font-black mb-6 italic text-indigo-600 uppercase tracking-tighter flex items-center gap-2">
                                                            <Icon name="database" size={18} /> All Merchants Control
                                                        </h3>
                                                        <div className="admin-table-container max-h-[500px] overflow-y-auto rounded-2xl border border-slate-100 shadow-inner">
                                                            <table className="w-full text-left text-[10px] font-bold bg-white">
                                                                <thead className="bg-slate-50 text-slate-400 sticky top-0 uppercase italic">
                                                                    <tr>
                                                                        <th className="p-3">ID</th>
                                                                        <th className="p-3">Merchant</th>
                                                                        <th className="p-3">Marketer</th>
                                                                        <th className="p-3">Std (Price/Rwd)</th>
                                                                        <th className="p-3">Pre (Price/Rwd)</th>
                                                                        <th className="p-3">Action</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {allMerchants.map(m => (
                                                                        <tr key={m.id} className="border-b border-slate-50 hover:bg-slate-50/50">
                                                                            <td className="p-3 text-indigo-600 font-black">{m.id}</td>
                                                                            <td className="p-3">{m.merchantName}</td>
                                                                            <td className="p-3 text-emerald-600 font-black">{m.marketerName || "-"}</td>
                                                                            <td className="p-3">
                                                                                <div className="flex gap-1">
                                                                                    <input type="number" className="w-14 p-1 border rounded bg-slate-50" defaultValue={m.stdPrice} id={`stdP_${m.id}`} />
                                                                                    <input type="number" className="w-14 p-1 border rounded bg-slate-50 text-indigo-500" defaultValue={m.stdReward} id={`stdR_${m.id}`} />
                                                                                </div>
                                                                            </td>
                                                                            <td className="p-3">
                                                                                <div className="flex gap-1">
                                                                                    <input type="number" className="w-14 p-1 border rounded bg-slate-50" defaultValue={m.prePrice} id={`preP_${m.id}`} />
                                                                                    <input type="number" className="w-14 p-1 border rounded bg-slate-50 text-teal-500" defaultValue={m.preReward} id={`preR_${m.id}`} />
                                                                                </div>
                                                                            </td>
                                                                            <td className="p-3">
                                                                                <div className="flex gap-1">
                                                                                    <button onClick={() => handleMasterPricingUpdate(m.id, {
                                                                                        stdPrice: Number(document.getElementById(`stdP_${m.id}`).value),
                                                                                        stdReward: Number(document.getElementById(`stdR_${m.id}`).value),
                                                                                        prePrice: Number(document.getElementById(`preP_${m.id}`).value),
                                                                                        preReward: Number(document.getElementById(`preR_${m.id}`).value),
                                                                                    })} className="px-2 py-1 bg-indigo-600 text-white rounded text-[9px] hover:bg-indigo-700 font-black">SAVE</button>
                                                                                    <button onClick={() => handleMasterPasswordReset(m.id)} className="px-2 py-1 bg-rose-500 text-white rounded text-[9px] hover:bg-rose-600 font-black flex items-center gap-1"><Icon name="refresh" size={8}/>RESET</button>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                        <p className="mt-3 text-[9px] text-slate-400 font-medium italic">* 마스터 관리자는 모든 매장의 매장명, 영업자명을 일괄 확인하고 계정 및 요금 정책을 제어할 수 있습니다.</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="flex-1 flex flex-col items-center justify-center mt-20"><div className="w-full max-w-sm bg-white p-12 rounded-[3.5rem] shadow-2xl text-center border border-slate-50"><h2 className="text-2xl font-black uppercase italic mb-8 tracking-tighter underline decoration-indigo-500 decoration-4">Admin Hub</h2><div className="space-y-4 mb-6"><input type="text" placeholder="ID" className="w-full p-5 bg-slate-50 rounded-2xl font-black text-center outline-none border-2 border-transparent focus:border-indigo-500" value={loginId} onChange={e => setLoginId(e.target.value)} /><input type="password" placeholder="Password" className="w-full p-5 bg-slate-50 rounded-2xl font-black text-center outline-none border-2 border-transparent focus:border-indigo-500" value={pw} onChange={e => setPw(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleLogin()} /></div><button onClick={handleLogin} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xs uppercase shadow-xl active:scale-[0.98] transition-all">Connect Dashboard</button><button onClick={() => setView('survey')} className="mt-4 text-slate-300 text-[10px] font-black uppercase tracking-widest">Return to App</button></div></div>
                            )}
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
